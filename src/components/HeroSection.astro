---
import HeroCanvas from './HeroCanvas.jsx'
import type { HeadingTag, TypographyRole } from '../types/typography'
import { animations } from '../data/tokens'

interface Props {
  headline: string
  tag?: HeadingTag
  role?: TypographyRole
}

const { headline, tag = 'h1', role = 'prose-title-lg' } = Astro.props as Props
const HeroTag = tag as any
const heroRole = `typo-${role}`

const revealCfg = animations.textReveal
const heroInitBlur = `${revealCfg.initialBlur}px`
---

<section class="hero" aria-label="Introduction">
  <div class="hero-canvas-fallback" aria-hidden="true"></div>
  <HeroCanvas client:only="react" />
  <div class="hero-text">
    <HeroTag class:list={["hero-block", heroRole]} data-hero-text>{headline}</HeroTag>
  </div>
</section>

<style define:vars={{ heroInitBlur }}>
  .hero {
    position: relative;
    width: 100%;
    height: 75vh;
    overflow: hidden;
    margin: 0 var(--page-margin);
    width: calc(100% - 2 * var(--page-margin));
    background-color: var(--color-bg-primary);
  }

  .hero-canvas-fallback {
    position: absolute;
    inset: 0;
    z-index: 0;
    background: radial-gradient(ellipse at 50% 60%, var(--color-bg-alt) 0%, var(--color-bg-primary) 70%);
  }

  .hero :global(astro-island) {
    position: absolute;
    inset: 0;
    z-index: 0;
    background-color: var(--color-bg-primary);
  }

  .hero-text {
    position: relative;
    width: 100%;
    min-height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 0 var(--page-margin);
    z-index: 2;
  }

  .hero-block {
    letter-spacing: var(--tracking-tight);
    color: var(--color-text-primary);
  }

  .hero-block {
    opacity: 0;
    filter: blur(var(--heroInitBlur));
  }

  @media (prefers-reduced-motion: reduce) {
    .hero-block {
      opacity: 1;
      transform: none;
      filter: none;
    }
  }
</style>

<script>
  import gsap from 'gsap'
  import { animations } from '../data/tokens'
  import { createCmyAutoSplitReveal, type CmyAutoSplitHandle } from './cmy-animate'

  const cfg = animations.textReveal
  const startDelay = animations.hero.text.startDelay

  let heroHandles: CmyAutoSplitHandle[] = []

  async function animateHero() {
    const els = document.querySelectorAll<HTMLElement>('[data-hero-text]')
    if (!els.length) return

    heroHandles.forEach(h => h.kill())
    heroHandles = []

    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches

    if (prefersReduced) {
      gsap.set(els, { opacity: 1, y: 0, filter: 'none', textShadow: 'none' })
      return
    }

    await document.fonts.ready

    els.forEach(el => {
      heroHandles.push(createCmyAutoSplitReveal(el, cfg, { delay: startDelay }))
    })
  }

  animateHero()
  document.addEventListener('astro:page-load', animateHero)
</script>
