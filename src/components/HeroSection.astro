---
import HeroCanvas from './HeroCanvas.jsx'
import typo from '../content/typography.json'

interface HeroBlock {
  tag?: string
  text: string
}

interface Props {
  blocks: HeroBlock[]
}

const { blocks } = Astro.props
const heroCfg = typo.tags.heroText
const defaultTag = heroCfg.tag
const heroRole = `typo-${heroCfg.role}`
---

<section class="hero" aria-label="Introduction">
  <div class="hero-canvas-fallback" aria-hidden="true"></div>
  <HeroCanvas client:only="react" />
  <div class="hero-text">
    {blocks.map(block => {
      const Tag = (block.tag || defaultTag) as any
      return <Tag class:list={["hero-block", heroRole]} data-hero-text>{block.text}</Tag>
    })}
  </div>
</section>

<style>
  .hero {
    position: relative;
    width: 100%;
    height: 100vh;
    margin-top: calc(var(--nav-height) * -1);
    overflow: hidden;
    background-color: var(--color-bg-primary);
  }

  .hero-canvas-fallback {
    position: absolute;
    inset: 0;
    z-index: 0;
    background: radial-gradient(ellipse at 50% 60%, var(--color-bg-alt) 0%, var(--color-bg-primary) 70%);
  }

  .hero :global(astro-island) {
    position: absolute;
    inset: 0;
    z-index: 0;
    background-color: var(--color-bg-primary);
  }

  .hero::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30%;
    background: linear-gradient(to bottom, transparent, var(--color-bg-primary));
    pointer-events: none;
    z-index: 1;
  }

  .hero-text {
    position: relative;
    width: 100%;
    max-width: var(--container-content);
    margin: 0 auto;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 0 var(--page-padding);
    z-index: 2;
  }

  .hero-block {
    letter-spacing: var(--tracking-tight);
    color: var(--color-text-primary);
  }

  .hero-block :global(.hero-word) {
    display: inline-block;
    opacity: 0;
    transform: translateY(40px);
    filter: blur(14px);
  }
</style>

<script>
  import gsap from 'gsap'
  import { SplitText } from 'gsap/SplitText'
  import animConfig from '../content/animations.json'

  gsap.registerPlugin(SplitText)

  const cfg = animConfig.hero.text

  let heroSplits: SplitText[] = []

  function animateHeroLines() {
    const els = document.querySelectorAll<HTMLElement>('[data-hero-text]')
    if (!els.length) return

    // Revert previous splits
    heroSplits.forEach(s => s.revert())
    heroSplits = []

    // Split each block into words
    const allWords: HTMLElement[] = []
    els.forEach(el => {
      const split = new SplitText(el, { type: 'words', wordsClass: 'hero-word' })
      heroSplits.push(split)
      allWords.push(...split.words)
    })

    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches

    if (prefersReduced) {
      gsap.set(allWords, { opacity: 1, y: 0, filter: 'blur(0px)', textShadow: 'none' })
      return
    }

    const d1 = cfg.aberration
    const d2 = d1 * 1.5
    const d3 = d1 * 2
    const op = cfg.aberrationOpacity
    const shadowFrom = `0 ${d1}px rgba(0,255,255,${op}), 0 ${d2}px rgba(255,0,255,${op}), 0 ${d3}px rgba(255,255,0,${op})`

    gsap.set(allWords, {
      opacity: 0, y: cfg.y, filter: `blur(${cfg.blur}px)`, textShadow: shadowFrom,
    })

    gsap.to(allWords, {
      opacity: 1, y: 0, filter: 'blur(0px)',
      textShadow: '0 0px transparent, 0 0px transparent, 0 0px transparent',
      duration: cfg.duration, stagger: cfg.stagger, ease: cfg.ease, delay: cfg.delay,
    })
  }

  animateHeroLines()
  document.addEventListener('astro:page-load', animateHeroLines)
</script>
