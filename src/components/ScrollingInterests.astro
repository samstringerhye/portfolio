---
import type { TypographyRole } from '../types/typography'
import { animations } from '../data/tokens'

interface Props {
  interests: string[]
  textRole?: TypographyRole
}

const { interests, textRole = 'prose-title-lg' } = Astro.props as Props
const text = interests.join(' \u00b7 ') + ' \u00b7 '
const copies = 4
const dg = animations.dotGrid
const dgCenter = dg.spacing / 2
---

<section class="interests-section" aria-label="Interests">
  <svg class="dot-grid" aria-hidden="true">
    <defs>
      <pattern id="dot-grid-pattern" x="0" y="0" width={dg.spacing} height={dg.spacing} patternUnits="userSpaceOnUse">
        <circle cx={dgCenter} cy={dgCenter} r={dg.radius} fill="currentColor" />
      </pattern>
    </defs>
    <rect width="100%" height="100%" fill="url(#dot-grid-pattern)" />
  </svg>
  <div class="interests-row" data-direction="left">
    <svg class="interests-svg-defs" aria-hidden="true">
      <defs>
        <filter id="distort-1" color-interpolation-filters="sRGB" x="-20%" y="-20%" width="140%" height="140%">
          <feTurbulence type="turbulence" baseFrequency="0.012" numOctaves="3" seed="42" result="noise" />
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="0" xChannelSelector="R" yChannelSelector="G" />
        </filter>
      </defs>
    </svg>
    <div class="interests-track" aria-hidden="true">
      {Array.from({ length: copies }, () => (
        <h3 class:list={["interests-text", `typo-${textRole}`]}>{text}</h3>
      ))}
    </div>
  </div>

  <div class="interests-row" data-direction="right">
    <svg class="interests-svg-defs" aria-hidden="true">
      <defs>
        <filter id="distort-2" color-interpolation-filters="sRGB" x="-20%" y="-20%" width="140%" height="140%">
          <feTurbulence type="turbulence" baseFrequency="0.012" numOctaves="3" seed="99" result="noise" />
          <feDisplacementMap in="SourceGraphic" in2="noise" scale="0" xChannelSelector="R" yChannelSelector="G" />
        </filter>
      </defs>
    </svg>
    <div class="interests-track" aria-hidden="true">
      {Array.from({ length: copies }, () => (
        <h3 class:list={["interests-text", `typo-${textRole}`]}>{text}</h3>
      ))}
    </div>
  </div>

  <p class="visually-hidden">{interests.join(', ')}</p>
</section>

<style define:vars={{ dotGridOpacity: dg.opacity }}>
  .interests-section {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: var(--space-2);
    overflow: hidden;
    margin-inline: var(--page-margin);
    padding-block: calc(var(--section-padding) * 8);
  }

  .dot-grid {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    color: var(--color-text-primary);
    opacity: var(--dotGridOpacity);
    pointer-events: none;
  }

  .interests-row {
    position: relative;
    overflow: hidden;
    cursor: default;
  }

  .interests-svg-defs {
    position: absolute;
    width: 0;
    height: 0;
    pointer-events: none;
  }

  .interests-track {
    display: flex;
    white-space: nowrap;
    will-change: transform;
  }

  .interests-text {
    color: var(--color-text-primary);
    padding: 0 var(--inline-spacing-1x);
    max-width: none;
    white-space: nowrap;
    text-wrap: nowrap;
    flex-shrink: 0;
    margin: 0;
  }
</style>

<script>
  import gsap from 'gsap'
  import { animations } from '../data/tokens'

  const scrollDuration = animations.interests.scrollDuration
  let interestsTweens: gsap.core.Tween[] = []

  function cleanupScrollingInterests() {
    interestsTweens.forEach(t => t.kill())
    interestsTweens = []
  }

  function initScrollingInterests() {
    cleanupScrollingInterests()

    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return
    const rows = document.querySelectorAll('.interests-row')

    rows.forEach((row, i) => {
      const track = row.querySelector('.interests-track')
      if (!track) return

      const copyWidth = (track as HTMLElement).scrollWidth / 4
      const direction = row.getAttribute('data-direction')
      const filterId = `distort-${i + 1}`

      ;(track as HTMLElement).style.filter = `url(#${filterId})`

      let tween: gsap.core.Tween

      if (direction === 'left') {
        tween = gsap.to(track, {
          x: -copyWidth,
          duration: scrollDuration,
          ease: 'none',
          repeat: -1,
          modifiers: {
            x: gsap.utils.unitize((x: string) => parseFloat(x) % copyWidth),
          },
        })
      } else {
        gsap.set(track, { x: -copyWidth })
        tween = gsap.to(track, {
          x: 0,
          duration: scrollDuration,
          ease: 'none',
          repeat: -1,
          modifiers: {
            x: gsap.utils.unitize((x: string) => {
              const v = parseFloat(x) % copyWidth
              return v === 0 ? 0 : v - copyWidth
            }),
          },
        })
      }

      interestsTweens.push(tween)
    })
  }

  initScrollingInterests()
  document.addEventListener('astro:page-load', initScrollingInterests)
  document.addEventListener('astro:before-swap', cleanupScrollingInterests)
</script>
