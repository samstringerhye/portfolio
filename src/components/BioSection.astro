---
interface Props {
  headline: string
  body: string
  headlineTag?: string
  headlineRole?: string
  bodyTag?: string
  bodyRole?: string
}

const {
  headline, body,
  headlineTag = 'h2', headlineRole = 'title',
  bodyTag = 'p', bodyRole = 'lead',
} = Astro.props
const HeadlineTag = headlineTag as any
const BodyTag = bodyTag as any
---

<section class="bio-section" aria-label="About">
  <div class="bio-inner">
    <HeadlineTag class:list={["bio-headline", `typo-${headlineRole}`]} data-reveal>{headline}</HeadlineTag>
    <BodyTag class:list={["bio-text", `typo-${bodyRole}`]} data-bio-text>{body}</BodyTag>
  </div>
</section>

<style>
  .bio-section {
    position: relative;
    z-index: 1;
    min-height: 100vh;
    display: flex;
    align-items: center;
    padding-block: var(--section-padding);
  }

  .bio-inner {
    width: 100%;
    max-width: var(--container-content);
    margin: 0 auto;
    padding-inline: var(--page-padding);
  }

  .bio-headline {
    color: var(--color-text-primary);
    margin-bottom: var(--space-3);
  }

  .bio-text {
    color: var(--color-text-primary);
  }

  .bio-text :global(.bio-line) {
    display: block;
    opacity: 0;
    transform: translateY(30px);
    filter: blur(14px);
  }

  @media (prefers-reduced-motion: reduce) {
    .bio-text :global(.bio-line) {
      opacity: 1;
      transform: none;
      filter: none;
    }
  }
</style>

<script>
  import gsap from 'gsap'
  import { ScrollTrigger } from 'gsap/ScrollTrigger'
  import { SplitText } from 'gsap/SplitText'
  import tokens from '../data/tokens.json'

  gsap.registerPlugin(ScrollTrigger, SplitText)

  const cfg = tokens.animations.bio

  let bioTrigger: globalThis.ScrollTrigger | null = null
  let bioSplit: SplitText | null = null

  function animateBioLines() {
    const el = document.querySelector<HTMLElement>('[data-bio-text]')
    if (!el) return

    if (bioTrigger) {
      bioTrigger.kill()
      bioTrigger = null
    }

    if (bioSplit) {
      bioSplit.revert()
      bioSplit = null
    }

    bioSplit = new SplitText(el, { type: 'lines', linesClass: 'bio-line' })
    const lines = bioSplit.lines

    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches

    if (prefersReduced) {
      gsap.set(lines, { opacity: 1, y: 0, filter: 'blur(0px)', textShadow: 'none' })
      return
    }

    const d1 = cfg.aberration, d2 = d1 * 1.5, d3 = d1 * 2, op = cfg.aberrationOpacity
    const shadowFrom = `0 ${d1}px rgba(0,255,255,${op}), 0 ${d2}px rgba(255,0,255,${op}), 0 ${d3}px rgba(255,255,0,${op})`

    gsap.set(lines, {
      opacity: 0, y: cfg.y, filter: `blur(${cfg.blur}px)`, textShadow: shadowFrom,
    })

    bioTrigger = ScrollTrigger.create({
      trigger: el,
      start: cfg.triggerStart,
      once: true,
      onEnter: () => {
        gsap.to(lines, {
          opacity: 1, y: 0, filter: 'blur(0px)',
          textShadow: '0 0px transparent, 0 0px transparent, 0 0px transparent',
          duration: cfg.duration, stagger: cfg.stagger, ease: cfg.ease,
        })
      },
    })
  }

  document.addEventListener('astro:page-load', animateBioLines)
</script>
