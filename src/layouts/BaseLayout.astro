---
import { ViewTransitions } from 'astro:transitions'
import SEO from '../components/SEO.astro'
import Nav from '../components/Nav.astro'
import Footer from '../components/Footer.astro'
import AboutModal from '../components/AboutModal.astro'
import tokens from '../data/tokens.json'
import '../styles/global.css'

interface Props {
  title?: string
  description?: string
  ogImage?: string
  hideFooter?: boolean
}

const { title, description, ogImage, hideFooter = false } = Astro.props

/* ── Helper: fluid clamp from min→max rem across 375→1440px ── */
function buildClamp(min: number, max: number): string {
  if (min === max) return `${min}rem`
  const rootPx = 17
  const slope = ((max - min) * rootPx * 100) / (1440 - 375)
  const intercept = min - (slope * 375) / (100 * rootPx)
  return `clamp(${min.toFixed(2)}rem, ${intercept.toFixed(4)}rem + ${slope.toFixed(4)}vw, ${max.toFixed(2)}rem)`
}

/* ── Helper: camelCase → kebab-case ── */
function kebab(s: string): string {
  return s.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase()
}

/* ── Typography vars ── */
const scaleVars = Object.entries(tokens.scale).map(([key, val]) => {
  if (typeof val === 'number') return `--text-${key}: ${val}rem;`
  const v = val as { min: number; max: number }
  return `--text-${key}: ${buildClamp(v.min, v.max)};`
}).join('\n    ')

const leadingVars = Object.entries(tokens.lineHeight)
  .map(([key, val]) => `--line-height-${key}: ${val};`).join('\n    ')

const trackingVars = Object.entries(tokens.tracking)
  .map(([key, val]) => `--tracking-${key}: ${val}em;`).join('\n    ')

const fonts = tokens.fonts as Record<string, string>
const fontVars = Object.entries(fonts)
  .map(([key, val]) => `--font-${key}: ${val};`).join('\n    ')

const fontWeights = tokens.fontWeight as Record<string, number>
const weightVars = Object.entries(fontWeights)
  .map(([key, val]) => `--font-weight-${key}: ${val};`).join('\n    ')

/* ── Color vars ── */
const colorVars = Object.entries(tokens.colors)
  .map(([key, val]) => `--color-${kebab(key)}: ${val};`).join('\n    ')

/* ── Spacing vars ── */
const spacingVars = Object.entries(tokens.spacing)
  .map(([key, val]) => `--space-${key}: ${val};`).join('\n    ')

/* ── Layout vars ── */
const layoutVars = [
  `--container-content: ${tokens.layout.contentWidth}px;`,
  `--page-padding: ${tokens.layout.pagePadding};`,
  `--grid-gutter: ${tokens.layout.gridGutter};`,
  `--section-padding: ${tokens.layout.sectionPadding};`,
  `--nav-height: ${tokens.layout.navHeight};`,
].join('\n    ')

/* ── Breakpoint vars (for JS access — CSS @media requires literal values) ── */
const breakpointVars = Object.entries(tokens.breakpoints)
  .map(([key, val]) => `--breakpoint-${key}: ${val}px;`).join('\n    ')

/* ── Radii vars ── */
const radiiVars = Object.entries(tokens.radii)
  .map(([key, val]) => `--radius-${key}: ${val};`).join('\n    ')

/* ── Z-index vars ── */
const zVars = Object.entries(tokens.zIndex)
  .map(([key, val]) => `--z-${kebab(key)}: ${val};`).join('\n    ')

/* ── Transition vars ── */
const transitionVars = Object.entries(tokens.transitions)
  .map(([key, val]) => `--transition-${key}: ${val};`).join('\n    ')

/* ── Modal vars ── */
const modalVars = Object.entries(tokens.modal)
  .map(([key, val]) => `--modal-${kebab(key)}: ${val};`).join('\n    ')

/* ── Scrollbar vars ── */
const scrollbarVars = Object.entries(tokens.scrollbar)
  .map(([key, val]) => `--scrollbar-${key}: ${val};`).join('\n    ')

/* ── Glow vars ── */
const glowVars = Object.entries(tokens.glow)
  .map(([key, val]) => `--glow-${key}: ${val};`).join('\n    ')

/* ── Hover vars ── */
const hoverVars = Object.entries(tokens.hover)
  .map(([key, val]) => {
    const unit = typeof val === 'number' && key !== 'perspective' ? '' : typeof val === 'number' ? 'px' : ''
    return `--hover-${kebab(key)}: ${val}${unit};`
  }).join('\n    ')

/* ── Font faces ── */
const fontFaces = [
  { name: 'PP Editorial New', src: '/fonts/trial/PPEditorialNew-Regular.otf' },
  { name: 'PP Neue Montreal', src: '/fonts/trial/PPNeueMontreal-Medium.otf' },
].map(f => `@font-face {
    font-family: "${f.name}";
    src: url("${f.src}") format("opentype");
    font-display: swap;
  }`).join('\n  ')

/* ── Typography role utility classes ── */
const roleRules = Object.entries(tokens.roles).map(([name, cfg]) => {
  const c = cfg as { font: string; scale: string; lineHeight: string; tracking: string }
  return `.typo-${name} {
    font-family: var(--font-${c.font});
    font-weight: var(--font-weight-${c.font});
    font-size: var(--text-${c.scale});
    line-height: var(--line-height-${c.lineHeight});
    letter-spacing: var(--tracking-${c.tracking});
  }`
}).join('\n  ')

/* ── Assemble the full :root block ── */
const typoCss = `${fontFaces}
  :root {
    ${fontVars}
    --font-primary: var(--font-sans-serif);
    ${weightVars}
    ${scaleVars}
    ${leadingVars}
    ${trackingVars}
    ${colorVars}
    ${spacingVars}
    ${layoutVars}
    ${breakpointVars}
    ${radiiVars}
    ${zVars}
    ${transitionVars}
    ${modalVars}
    ${scrollbarVars}
    ${glowVars}
    ${hoverVars}
    --focus-ring: 0 0 0 2px var(--color-bg-primary), 0 0 0 4px var(--color-text-primary);
    --border-light: 1px solid var(--color-border);
  }
  ${roleRules}`
---

<!doctype html>
<html lang="en">
  <head>
    <SEO title={title} description={description} ogImage={ogImage} />
    <link rel="preload" href="/fonts/trial/PPEditorialNew-Regular.otf" as="font" type="font/otf" crossorigin />
    <link rel="preload" href="/fonts/trial/PPNeueMontreal-Medium.otf" as="font" type="font/otf" crossorigin />
    <style set:html={typoCss}></style>
    <noscript><style>.hero-word, .bio-line { opacity: 1 !important; transform: none !important; filter: none !important; }</style></noscript>
    <ViewTransitions fallback="swap" />
  </head>
  <body>
    <a href="#main" class="skip-to-content">Skip to content</a>
    <Nav />
    <main id="main" tabindex="-1" style="padding-top: var(--nav-height);">
      <slot />
    </main>
    {!hideFooter && <Footer />}
    <AboutModal />

    <script>
      import Lenis from 'lenis'
      import gsap from 'gsap'
      import { ScrollTrigger } from 'gsap/ScrollTrigger'
      import tokens from '../data/tokens.json'

      gsap.registerPlugin(ScrollTrigger)

      const scrollCfg = tokens.animations.smoothScroll
      let lenis: InstanceType<typeof Lenis> | null = null

      function initLenis() {
        lenis?.destroy()

        // Respect reduced motion
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches
        if (prefersReduced) return

        lenis = new Lenis({ lerp: scrollCfg.lerp, smoothWheel: true, wheelMultiplier: scrollCfg.wheelMultiplier })

        lenis.on('scroll', ScrollTrigger.update)
        gsap.ticker.add((time) => lenis?.raf(time * 1000))
        gsap.ticker.lagSmoothing(0)
      }

      async function initInteractions() {
        const { initScrollReveals } = await import('../components/scroll-reveals.ts')
        const { initHoverEffects } = await import('../components/hover-effects.ts')
        initScrollReveals()
        initHoverEffects()
      }

      initLenis()
      initInteractions()

      document.addEventListener('astro:after-swap', () => {
        initLenis()
        ScrollTrigger.refresh()
      })

      document.addEventListener('astro:page-load', initInteractions)
    </script>

    <script src="../components/about-modal.ts"></script>
  </body>
</html>
